# Story 1.2: MCP Tool Routing Implementation

## Status
Draft

## Story
**As a** platform developer,  
**I want** to assess and enhance the existing MCP tool routing system with improved BMAD integration, enhanced fallback mechanisms, and optimized workflow support,  
**so that** the deployed BMAD workflows, agents, and templates operate with improved reliability, performance, and seamless tool integration.

## Acceptance Criteria
1. Current MCP tool routing system is assessed and validated
2. Existing tool registry integration is tested and enhanced as needed
3. Fallback mechanisms are assessed and improved for better resilience
4. Circuit breaker patterns are validated and optimized
5. Tool execution monitoring and logging are assessed and enhanced
6. All existing MCP tools are validated and optimized for cloud execution
7. Performance is measured and optimized to meet sub-5 second requirements
8. BMAD Workflow API endpoints are validated and enhanced
9. BMAD Agent API endpoints are validated and enhanced
10. BMAD Template API endpoints are validated and enhanced
11. Enhanced MCP tools for BMAD workflows are assessed and improved
12. Project type detection system is validated and optimized
13. Expansion pack integration is assessed and enhanced
14. Provider router integration is validated and optimized
15. Workflow routing logic is assessed and enhanced for better performance

## Tasks / Subtasks
- [ ] Assess current MCP tool routing system (AC: 1)
  - [ ] **Current State Assessment**: Test existing WebMCP server functionality
  - [ ] Validate HTTP API facade and tool execution routing
  - [ ] Test tool registry integration from cflow-platform
  - [ ] Assess authentication and authorization mechanisms
  - [ ] **Enhancement Tasks**: Optimize routing performance, fix issues, improve reliability
- [ ] Assess and enhance tool registry integration (AC: 2)
  - [ ] **Current State Assessment**: Test existing ToolRegistry.get_tools_for_mcp() integration
  - [ ] Validate tool specification loading and validation
  - [ ] Test tool group management and filtering
  - [ ] Assess dynamic tool registration and discovery
  - [ ] **Enhancement Tasks**: Optimize tool loading, improve caching, enhance discovery
- [ ] Assess and improve fallback mechanisms (AC: 3)
  - [ ] **Current State Assessment**: Test existing retry logic and timeout handling
  - [ ] Validate graceful degradation for service failures
  - [ ] Test fallback to local execution when needed
  - [ ] **Enhancement Tasks**: Optimize retry strategies, improve timeout handling, enhance fallback logic
- [ ] Assess and optimize circuit breaker patterns (AC: 4)
  - [ ] **Current State Assessment**: Test existing circuit breaker implementation
  - [ ] Validate failure threshold and recovery timeouts
  - [ ] Test health check endpoints and automatic failover
  - [ ] **Enhancement Tasks**: Optimize thresholds, improve recovery logic, enhance monitoring
- [ ] Assess and enhance monitoring and logging (AC: 5)
  - [ ] **Current State Assessment**: Evaluate existing tool execution metrics and logging
  - [ ] Test structured logging and performance monitoring
  - [ ] Validate alerting rules and distributed tracing
  - [ ] **Enhancement Tasks**: Optimize metrics collection, improve alerting, enhance tracing
  - [ ] **Metrics Thresholds**: Response time >5s (warning), >10s (critical), Error rate >5% (warning), >10% (critical)
  - [ ] **Alerting Rules**: Circuit breaker activation, timeout failures, high error rates, performance degradation
- [ ] Assess and enhance BMAD Workflow API endpoints (AC: 8)
  - [ ] **Current State Assessment**: Test existing BMAD workflow endpoints
  - [ ] Validate POST /bmad/workflows/start, GET /bmad/workflows/{id}/status functionality
  - [ ] Test POST /bmad/workflows/{id}/next, GET /bmad/workflows/{id}/result endpoints
  - [ ] **Enhancement Tasks**: Optimize performance, improve error handling, enhance functionality
- [ ] Assess and enhance BMAD Agent API endpoints (AC: 9)
  - [ ] **Current State Assessment**: Test existing BMAD agent endpoints
  - [ ] Validate POST /bmad/agents/{persona}/activate, POST /bmad/agents/{persona}/execute
  - [ ] Test GET /bmad/agents/{persona}/status endpoint
  - [ ] **Enhancement Tasks**: Optimize agent activation, improve task execution, enhance monitoring
- [ ] Assess and enhance BMAD Template API endpoints (AC: 10)
  - [ ] **Current State Assessment**: Test existing BMAD template endpoints
  - [ ] Validate GET /bmad/templates, GET /bmad/templates/{id} functionality
  - [ ] Test POST /bmad/templates/{id}/instantiate endpoint
  - [ ] **Enhancement Tasks**: Optimize template loading, improve instantiation, enhance caching
- [ ] Assess and enhance Enhanced MCP Tools (AC: 11)
  - [ ] **Current State Assessment**: Test existing BMAD-specific MCP tools
  - [ ] Validate bmad_workflow_start, bmad_workflow_next, bmad_workflow_status tools
  - [ ] Test bmad_agent_activate, bmad_template_get, bmad_template_instantiate tools
  - [ ] **Enhancement Tasks**: Optimize tool performance, improve error handling, enhance functionality
- [ ] Assess and optimize Project Type Detection System (AC: 12)
  - [ ] **Current State Assessment**: Test existing project type detection
  - [ ] Validate POST /bmad/project-type/detect accuracy and performance
  - [ ] Test greenfield and brownfield endpoint routing
  - [ ] **Enhancement Tasks**: Improve detection accuracy, optimize routing logic, enhance performance
- [ ] Assess and enhance Expansion Pack Integration (AC: 13)
  - [ ] **Current State Assessment**: Test existing expansion pack functionality
  - [ ] Validate POST /bmad/expansion-packs/install, GET /bmad/expansion-packs/list
  - [ ] Test POST /bmad/expansion-packs/enable and dynamic loading
  - [ ] **Enhancement Tasks**: Optimize pack loading, improve installation, enhance management
- [ ] Assess and optimize Provider Router Integration (AC: 14)
  - [ ] **Current State Assessment**: Test existing LLM provider routing
  - [ ] Validate OpenRouter, Ollama, and other provider integrations
  - [ ] Test provider selection and failover logic
  - [ ] **Enhancement Tasks**: Optimize provider selection, improve failover, enhance performance
- [ ] Validate and optimize tool compatibility and BMAD integration (AC: 6, 7, 15)
  - [ ] **Current State Assessment**: Test all existing MCP tools in cloud environment
  - [ ] Measure tool execution performance and response times
  - [ ] Validate tool registry integration and discovery mechanisms
  - [ ] Test fallback mechanisms and circuit breaker behavior
  - [ ] **Enhancement Tasks**: Optimize tool performance, improve integration, enhance reliability
  - [ ] **Performance Optimization**: Target sub-5 second response times, optimize resource usage
  - [ ] **Integration Testing**: Validate BMAD workflow, agent, and template functionality
  - [ ] **System Testing**: Test project type detection, expansion pack loading, provider routing

## Dev Notes

### Previous Story Insights
**From Story 1.1 (Infrastructure Setup):**
- Current infrastructure deployment status assessed and documented
- BMAD-API service functionality validated and enhanced as needed
- OAuth2Proxy authentication verified and optimized for enterprise use
- Sealed Secrets Controller validated and enhanced for security
- Monitoring and observability assessed and improved
- Infrastructure gaps identified and enhancement opportunities documented

### Brownfield Assessment Context
**Current Deployed MCP System (Based on Architecture Documentation):**
- **WebMCP Server**: `webmcp-deployment` running on `mcp.cerebral.baerautotech.com` with dual transport (STDIO + HTTP)
- **BMAD HTTP API Facade**: Deployed to cerebral cluster with comprehensive endpoints
- **Tool Registry**: Imported from `cflow_platform.core.tool_registry` with 50+ tools
- **BMAD Integration**: Project type detection, greenfield/brownfield routing, expansion packs
- **Provider Router**: LLM API routing with OpenRouter, Ollama integration

**Architecture Claims vs. Reality Assessment:**
- **Architecture docs claim**: "COMPLETED" cluster deployment tasks for BMAD integration
- **Reality check needed**: Validate what's actually deployed and working
- **Focus**: Enhance existing MCP routing rather than rebuild from scratch
- **Approach**: Assess current functionality, identify performance gaps, implement optimizations

### Data Models
**Tool Registry Schema:**
- Tool specifications with name, description, inputSchema, group, metadata [Source: cflow_platform/core/tool_registry.py#tool-function]
- Tool group management with required flags and client types [Source: cflow_platform/core/tool_group_manager.py]
- Tool execution context with tenant isolation and authentication [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]

**MCP Tool Execution Schema:**
- Tool call request: {tool_name, arguments, context, tenant_id}
- Tool call response: {status, result, error, execution_time, metadata}
- Circuit breaker state: {failure_count, last_failure_time, state, threshold}

### API Specifications
**MCP Tool Routing Endpoints:**
- POST /mcp/tools/execute: Execute MCP tool with arguments [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- GET /mcp/tools/list: List available tools from registry [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- GET /mcp/tools/{tool_name}/spec: Get tool specification [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- POST /mcp/tools/{tool_name}/validate: Validate tool arguments [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]

**BMAD Workflow API Endpoints:**
- POST /bmad/workflows/start: Start BMAD workflow with project context [Source: docs/architecture.md#rest-api-wrapper-services]
- GET /bmad/workflows/{id}/status: Get workflow execution status [Source: docs/architecture.md#rest-api-wrapper-services]
- POST /bmad/workflows/{id}/next: Execute next workflow step [Source: docs/architecture.md#rest-api-wrapper-services]
- GET /bmad/workflows/{id}/result: Get workflow results [Source: docs/architecture.md#rest-api-wrapper-services]

**BMAD Agent API Endpoints:**
- POST /bmad/agents/{persona}/activate: Activate specific BMAD agent persona [Source: docs/architecture.md#rest-api-wrapper-services]
- POST /bmad/agents/{persona}/execute: Execute agent task [Source: docs/architecture.md#rest-api-wrapper-services]
- GET /bmad/agents/{persona}/status: Get agent execution status [Source: docs/architecture.md#rest-api-wrapper-services]

**BMAD Template API Endpoints:**
- GET /bmad/templates: List available BMAD templates [Source: docs/architecture.md#rest-api-wrapper-services]
- GET /bmad/templates/{id}: Get specific template [Source: docs/architecture.md#rest-api-wrapper-services]
- POST /bmad/templates/{id}/instantiate: Instantiate template with context [Source: docs/architecture.md#rest-api-wrapper-services]

**Project Type Detection Endpoints:**
- POST /bmad/project-type/detect: Automatic greenfield vs brownfield detection [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- Greenfield Endpoints: /bmad/greenfield/prd-create, /bmad/greenfield/arch-create, /bmad/greenfield/story-create [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- Brownfield Endpoints: /bmad/brownfield/document-project, /bmad/brownfield/prd-create, /bmad/brownfield/arch-create, /bmad/brownfield/story-create [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]

**Expansion Pack Endpoints:**
- POST /bmad/expansion-packs/install: Install expansion packs [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- GET /bmad/expansion-packs/list: List available expansion packs [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- POST /bmad/expansion-packs/enable: Enable expansion packs [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]

**Tool Registry Integration:**
- Import ToolRegistry.get_tools_for_mcp() from cflow_platform.core.tool_registry [Source: docs/architecture/MCP_ARCHITECTURE.md#tool-registry-cflow-platform]
- Tool specifications with group management and metadata [Source: cflow_platform/core/tool_registry.py#get_tools_for_mcp]
- Tool group filtering by client types and project types [Source: cflow_platform/core/tool_group_manager.py]

**Enhanced MCP Tools for BMAD:**
- bmad_workflow_start: Start BMAD workflow with project context [Source: docs/architecture.md#mcp-tool-integration]
- bmad_workflow_next: Execute next workflow step [Source: docs/architecture.md#mcp-tool-integration]
- bmad_workflow_status: Get workflow execution status [Source: docs/architecture.md#mcp-tool-integration]
- bmad_agent_activate: Activate BMAD agent persona [Source: docs/architecture.md#mcp-tool-integration]
- bmad_template_get: Get BMAD template [Source: docs/architecture.md#mcp-tool-integration]
- bmad_template_instantiate: Instantiate BMAD template [Source: docs/architecture.md#mcp-tool-integration]

### Component Specifications
**MCP Tool Router Service:**
- HTTP API facade for tool execution with authentication [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- Tool registry integration with dynamic tool loading [Source: docs/architecture/MCP_ARCHITECTURE.md#tool-registry-cflow-platform]
- Circuit breaker pattern implementation for resilience [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]

**BMAD HTTP API Facade:**
- BMAD Service deployment to cerebral cluster [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- Project type detection system for greenfield vs brownfield [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- Workflow routing system for appropriate project workflows [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- Dynamic expansion pack loading based on project requirements [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]

**Provider Router Integration:**
- Route BMAD agent calls to hosted LLM APIs [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- Integration with OpenRouter, Ollama, and other LLM providers [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- LLM provider selection and failover logic
- Provider-specific authentication and configuration

**Fallback Mechanisms:**
- Retry logic with exponential backoff for failed executions [Source: cflow_platform/core/direct_client.py#execute_mcp_tool]
- **Timeout Configuration**: 30s default timeout, 60s maximum timeout for long-running tools
- **Retry Configuration**: 3 retry attempts with exponential backoff (1s, 2s, 4s intervals)
- Graceful degradation with local execution fallback
- Health check endpoints for service monitoring

**Circuit Breaker Configuration:**
- Failure threshold: 5 consecutive failures
- Recovery timeout: 30 seconds
- Half-open state testing: 1 request per 10 seconds
- Automatic state transitions based on success/failure rates

### File Locations
**Core MCP Components:**
- Tool registry: `cflow_platform/core/tool_registry.py` [Source: docs/architecture/MCP_ARCHITECTURE.md#tool-registry-cflow-platform]
- Direct client: `cflow_platform/core/direct_client.py` [Source: docs/architecture/MCP_ARCHITECTURE.md#direct-client-cflow-platform]
- Handler loader: `cflow_platform/core/handler_loader.py`
- Tool group manager: `cflow_platform/core/tool_group_manager.py`

**BMAD-API Service:**
- Main service: `bmad_api_service/main.py`
- Tool routing: `bmad_api_service/mcp_tool_router.py` (to be created)
- Circuit breaker: `bmad_api_service/circuit_breaker.py` (to be created)
- Tool registry client: `bmad_api_service/tool_registry_client.py` (to be created)
- BMAD workflow API: `bmad_api_service/bmad_workflow_api.py` (to be created)
- BMAD agent API: `bmad_api_service/bmad_agent_api.py` (to be created)
- BMAD template API: `bmad_api_service/bmad_template_api.py` (to be created)
- Project type detection: `bmad_api_service/project_type_detector.py` (to be created)
- Expansion pack manager: `bmad_api_service/expansion_pack_manager.py` (to be created)
- Provider router: `bmad_api_service/provider_router.py` (to be created)

**Kubernetes Manifests:**
- BMAD-API deployment: `infrastructure/kubernetes/bmad-api-enhanced-deployment.yaml`
- Service configuration: `infrastructure/kubernetes/bmad-api-service.yaml`
- Ingress configuration: `infrastructure/kubernetes/bmad-api-ingress.yaml`

### Testing Requirements
**Tool Routing Testing:**
- Test all MCP tools execute correctly through cloud routing
- Validate tool registry integration and tool discovery
- Test fallback mechanisms with simulated failures
- Verify circuit breaker behavior and recovery

**Performance Testing:**
- Measure tool execution response times (target: <5 seconds)
- Test concurrent tool execution and load handling
- Validate monitoring and metrics collection
- Test timeout handling and graceful degradation

**Integration Testing:**
- Test tool routing with OAuth2Proxy authentication
- Validate tenant isolation and access control
- Test tool execution with different client types
- Verify tool group filtering and project type routing

### Technical Constraints
**Performance Requirements:**
- Sub-5 second response time for tool execution [Source: docs/architecture.md#success-criteria]
- 99.9% uptime with automated failover [Source: docs/architecture.md#success-criteria]
- Horizontal scaling with load balancing [Source: docs/architecture.md#performance-architecture]

**Security Requirements:**
- JWT-based authentication with tenant isolation [Source: docs/architecture/MCP_ARCHITECTURE.md#phase-2]
- Tool execution with proper access control and authorization
- Secure tool registry integration with encrypted communication
- Audit logging for all tool executions and access attempts

**Compatibility Requirements:**
- All existing MCP tools must continue to work [Source: docs/architecture.md#compatibility-requirements]
- Tool registry compatibility with cflow-platform integration [Source: docs/architecture/MCP_ARCHITECTURE.md#tool-registry-cflow-platform]
- Backward compatibility with existing tool specifications and schemas
- Seamless integration with existing handler modules and tool groups

### Testing Standards
**Test File Location:**
- MCP tool routing tests: `tests/test_mcp_tool_routing.py`
- Tool registry tests: `tests/test_tool_registry_integration.py`
- Circuit breaker tests: `tests/test_circuit_breaker.py`
- Performance tests: `tests/test_mcp_performance.py`

**Testing Frameworks:**
- pytest for unit and integration tests
- httpx for HTTP API testing
- asyncio for asynchronous tool execution testing
- Kubernetes testing with kubectl validation

**Testing Patterns:**
- Tool execution validation tests
- Fallback mechanism tests with simulated failures
- Circuit breaker state transition tests
- Performance benchmark tests with load simulation
- Integration tests with authentication and tenant isolation
- BMAD workflow execution tests
- BMAD agent activation and execution tests
- BMAD template loading and instantiation tests
- Project type detection accuracy tests
- Expansion pack loading and integration tests
- Provider router and LLM integration tests

### Monitoring Metrics Specification
**MCP Tool Routing Metrics:**
- **Tool Execution Metrics**: Response times (target <5s), success/failure rates, execution counts
- **Circuit Breaker Metrics**: State transitions, failure counts, recovery times
- **Fallback Metrics**: Retry attempts, timeout occurrences, fallback activations
- **Performance Thresholds**: 
  - Response time >5s (warning alert), >10s (critical alert)
  - Error rate >5% (warning alert), >10% (critical alert)
  - Circuit breaker activation (immediate alert)
  - Timeout failures >10% (warning alert)

**BMAD Integration Metrics:**
- **Workflow Execution Metrics**: Workflow start/stop times, step execution times, completion rates
- **Agent Performance Metrics**: Agent activation times, task execution times, success rates
- **Template Metrics**: Template loading times, instantiation success rates, usage patterns
- **Project Type Detection Metrics**: Detection accuracy, routing decision times, project classification
- **Expansion Pack Metrics**: Pack loading times, installation success rates, usage statistics
- **Provider Router Metrics**: LLM provider selection times, failover occurrences, response times

**Alerting Configuration:**
- **Warning Alerts**: Response time >5s, error rate >5%, timeout failures >10%
- **Critical Alerts**: Response time >10s, error rate >10%, circuit breaker activation
- **Immediate Alerts**: Service down, authentication failures, security violations

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-01-09 | 1.1 | Added optional enhancements: timeout values, retry configuration, metrics thresholds | Bob (Scrum Master) |
| 2025-01-09 | 1.2 | Expanded with all missing BMAD-specific requirements: workflows, agents, templates, project detection, expansion packs, provider routing | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*
